<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار PayPal الشامل</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .test-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.2s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 اختبار PayPal الشامل</h1>
        
        <div class="test-section">
            <h2>1. اختبار تحميل PayPal SDK</h2>
            <button class="test-button" onclick="testSDKLoad()">اختبار تحميل SDK</button>
            <div id="sdk-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. اختبار الدفع العادي بـ PayPal</h2>
            <button class="test-button" onclick="testPayPalPayment()">اختبار الدفع العادي</button>
            <div id="paypal-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. اختبار الدفع بالبطاقة</h2>
            <button class="test-button" onclick="testCardPayment()">اختبار الدفع بالبطاقة</button>
            <div id="card-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. اختبار كامل للتدفق</h2>
            <button class="test-button" onclick="testCompleteFlow()">اختبار التدفق الكامل</button>
            <div id="complete-result" class="result"></div>
        </div>
    </div>

    <script>
        // معالجة أخطاء postMessage
        window.addEventListener('error', function(event) {
            if (event.message && event.message.includes('postMessage')) {
                console.warn('⚠️ تم تجاهل خطأ postMessage من PayPal SDK');
                event.preventDefault();
                return false;
            }
        });

        // معالجة الأخطاء غير المعالجة
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && event.reason.message.includes('postMessage')) {
                console.warn('⚠️ تم تجاهل Promise rejection من PayPal SDK');
                event.preventDefault();
                return false;
            }
        });

        // محاكاة PayPalService
        class PayPalService {
            static CLIENT_ID = 'AcNsW7s0g8FV5sp4fjaOn5njkd7XOx4uDVplDRTJ4E37pPvs7YrAG6LMGcQP3I6PX4zTtxoz-hZf35pM'; // Sandbox Client ID
            static SDK_URL = `https://www.paypal.com/sdk/js?client-id=${PayPalService.CLIENT_ID}&currency=USD&intent=capture&components=buttons&enable-funding=card,credit&disable-funding=venmo,paylater`;

            static diagnoseSDKIssues() {
                console.log('🔍 تشخيص مشاكل PayPal SDK...');
                console.log('🌐 Navigator online:', navigator.onLine);
                console.log('🔗 Client ID:', PayPalService.CLIENT_ID);
                console.log('📍 SDK URL:', PayPalService.SDK_URL);
                
                // اختبار الوصول لـ PayPal
                fetch('https://www.paypal.com/sdk/js', { method: 'HEAD', mode: 'no-cors' })
                    .then(() => console.log('✅ يمكن الوصول لخادم PayPal'))
                    .catch(err => console.error('❌ لا يمكن الوصول لخادم PayPal:', err));
            }

            static async loadSDK() {
                return new Promise((resolve, reject) => {
                    try {
                        if (window.paypal) {
                            console.log('✅ PayPal SDK موجود مسبقاً');
                            resolve(true);
                            return;
                        }

                        // تنظيف السكربتات السابقة
                        const existing = document.querySelectorAll('script[src*="paypal.com/sdk/js"]');
                        existing.forEach(s => {
                            try {
                                s.parentElement?.removeChild(s);
                            } catch (e) {
                                console.warn('تحذير: لا يمكن إزالة سكربت PayPal سابق');
                            }
                        });

                        const script = document.createElement('script');
                        script.src = PayPalService.SDK_URL;
                        script.async = true;
                        script.crossOrigin = 'anonymous';
                        
                        // إضافة timeout
                        const timeout = setTimeout(() => {
                            reject(new Error('انتهت مهلة تحميل PayPal SDK (15 ثانية)'));
                        }, 15000);

                        script.onload = () => {
                            clearTimeout(timeout);
                            console.log('✅ تم تحميل سكربت PayPal');
                            
                            let attempts = 0;
                            const maxAttempts = 50;
                            const interval = 200;

                            const check = () => {
                                attempts++;
                                try {
                                    if (window.paypal && window.paypal.Buttons) {
                                        console.log('✅ PayPal SDK جاهز');
                                        resolve(true);
                                        return;
                                    }
                                } catch (e) {
                                    console.warn('تحذير أثناء فحص PayPal:', e.message);
                                }
                                
                                if (attempts >= maxAttempts) {
                                    reject(new Error('PayPal SDK لم يتهيأ بعد التحميل'));
                                    return;
                                }
                                setTimeout(check, interval);
                            };
                            
                            setTimeout(check, interval);
                        };

                        script.onerror = (error) => {
                            clearTimeout(timeout);
                            console.error('❌ خطأ في تحميل PayPal SDK:', error);
                            reject(new Error('فشل تحميل PayPal SDK'));
                        };

                        document.head.appendChild(script);
                        
                    } catch (error) {
                        console.error('❌ خطأ عام في loadSDK:', error);
                        reject(error);
                    }
                });
            }

            static createOrderData() {
                return {
                    intent: 'CAPTURE',
                    purchase_units: [{
                        amount: {
                            currency_code: 'USD',
                            value: '29.99'
                        },
                        description: 'Trading Bot Subscription Test'
                    }],
                    application_context: {
                        brand_name: 'Trading Bot Pro',
                        landing_page: 'BILLING',
                        user_action: 'PAY_NOW',
                        shipping_preference: 'NO_SHIPPING'
                    }
                };
            }
        }

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (element.textContent) {
                element.textContent += logMessage;
            } else {
                element.textContent = logMessage;
            }
            
            element.className = `result ${type}`;
            element.scrollTop = element.scrollHeight;
        }

        async function testSDKLoad() {
            const resultId = 'sdk-result';
            log(resultId, '🔄 بدء اختبار تحميل PayPal SDK...');
            
            // تشخيص المشاكل أولاً
            PayPalService.diagnoseSDKIssues();
            
            try {
                const success = await PayPalService.loadSDK();
                if (success && window.paypal) {
                    log(resultId, '✅ تم تحميل PayPal SDK بنجاح', 'success');
                    log(resultId, `📊 محتويات window.paypal: ${Object.keys(window.paypal).join(', ')}`);
                    log(resultId, `🔍 Orders API متاح: ${!!window.paypal.Orders}`);
                    log(resultId, `🔍 Buttons API متاح: ${!!window.paypal.Buttons}`);
                } else {
                    log(resultId, '❌ فشل في تحميل PayPal SDK', 'error');
                }
            } catch (error) {
                log(resultId, `❌ خطأ: ${error.message}`, 'error');
            }
        }

        async function testPayPalPayment() {
            const resultId = 'paypal-result';
            log(resultId, '🔄 بدء اختبار الدفع العادي...');
            
            try {
                if (!window.paypal) {
                    await PayPalService.loadSDK();
                }

                const orderData = PayPalService.createOrderData();
                log(resultId, '📋 بيانات الطلب تم إنشاؤها بنجاح', 'success');
                log(resultId, `💰 المبلغ: ${orderData.purchase_units[0].amount.value} ${orderData.purchase_units[0].amount.currency_code}`);
                log(resultId, `🚫 الشحن: ${orderData.application_context.shipping_preference}`);
                
                // إنشاء حاوية للأزرار
                const buttonsContainer = document.createElement('div');
                buttonsContainer.id = 'paypal-buttons-test';
                buttonsContainer.style.marginTop = '15px';
                document.getElementById(resultId).appendChild(buttonsContainer);

                const buttons = window.paypal.Buttons({
                    createOrder: (data, actions) => {
                        return actions.order.create(orderData);
                    },
                    onApprove: async (data, actions) => {
                        try {
                            const capture = await actions.order.capture();
                            log(resultId, '✅ تم الدفع بنجاح!', 'success');
                            log(resultId, `🆔 Order ID: ${capture.id}`);
                            log(resultId, `💳 المبلغ المدفوع: ${capture.purchase_units[0].payments.captures[0].amount.value}`);
                            buttonsContainer.remove();
                        } catch (err) {
                            log(resultId, `❌ فشل في capture: ${err.message}`, 'error');
                        }
                    },
                    onCancel: () => {
                        log(resultId, '⚠️ تم إلغاء الدفع من قبل المستخدم', 'error');
                        buttonsContainer.remove();
                    },
                    onError: (err) => {
                        log(resultId, `❌ خطأ في PayPal: ${err.message || err}`, 'error');
                        buttonsContainer.remove();
                    }
                });

                if (buttons && buttons.render) {
                    await buttons.render('#paypal-buttons-test');
                    log(resultId, '✅ تم عرض أزرار PayPal بنجاح', 'success');
                } else {
                    log(resultId, '❌ فشل في عرض أزرار PayPal', 'error');
                }

            } catch (error) {
                log(resultId, `❌ خطأ: ${error.message}`, 'error');
            }
        }

        async function testCardPayment() {
            const resultId = 'card-result';
            log(resultId, '🔄 بدء اختبار الدفع بالبطاقة...');
            
            try {
                if (!window.paypal) {
                    await PayPalService.loadSDK();
                }

                log(resultId, '💳 محاكاة نافذة الدفع بالبطاقة...', 'info');
                log(resultId, '📝 الحقول المطلوبة: الاسم، الدولة، المدينة، العنوان، الهاتف');
                
                // محاكاة عملية الدفع
                setTimeout(() => {
                    const mockTransactionId = 'CARD_' + Math.random().toString(36).substr(2, 9).toUpperCase();
                    log(resultId, '✅ تم الدفع بالبطاقة بنجاح (محاكاة)', 'success');
                    log(resultId, `🆔 Transaction ID: ${mockTransactionId}`);
                    log(resultId, `💰 المبلغ: 29.99 USD`);
                    log(resultId, `📧 البريد: card-payment@example.com`);
                }, 2000);

            } catch (error) {
                log(resultId, `❌ خطأ: ${error.message}`, 'error');
            }
        }

        async function testCompleteFlow() {
            const resultId = 'complete-result';
            log(resultId, '🔄 بدء الاختبار الشامل...');
            
            try {
                // 1. تحميل SDK
                log(resultId, '1️⃣ اختبار تحميل SDK...');
                await PayPalService.loadSDK();
                log(resultId, '✅ SDK تم تحميله بنجاح');

                // 2. إنشاء بيانات الطلب
                log(resultId, '2️⃣ إنشاء بيانات الطلب...');
                const orderData = PayPalService.createOrderData();
                log(resultId, '✅ بيانات الطلب جاهزة');

                // 3. فحص APIs
                log(resultId, '3️⃣ فحص APIs المتاحة...');
                log(resultId, `Orders API: ${window.paypal.Orders ? '✅' : '❌'}`);
                log(resultId, `Buttons API: ${window.paypal.Buttons ? '✅' : '❌'}`);
                log(resultId, `Funding: ${window.paypal.FUNDING ? '✅' : '❌'}`);

                // 4. اختبار إنشاء الطلب
                if (window.paypal.Orders) {
                    log(resultId, '4️⃣ اختبار Orders API...');
                    // هذا سيتطلب client-side token، لذا نتخطاه في الاختبار
                    log(resultId, '⚠️ Orders API يتطلب server-side implementation');
                }

                // 5. اختبار الأزرار
                log(resultId, '5️⃣ اختبار Buttons API...');
                if (window.paypal.Buttons) {
                    log(resultId, '✅ Buttons API جاهز للاستخدام');
                } else {
                    log(resultId, '❌ Buttons API غير متاح');
                }

                log(resultId, '🎉 اكتمل الاختبار الشامل بنجاح!', 'success');
                log(resultId, '💡 النصيحة: استخدم الأزرار أعلاه لاختبار الوظائف الفردية');

            } catch (error) {
                log(resultId, `❌ فشل الاختبار الشامل: ${error.message}`, 'error');
            }
        }

        // تشغيل اختبار أولي عند تحميل الصفحة
        window.onload = () => {
            console.log('🚀 صفحة اختبار PayPal جاهزة');
        };
    </script>
</body>
</html>
