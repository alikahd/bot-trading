<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± PayPal Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .test-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.2s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± PayPal Ø§Ù„Ø´Ø§Ù…Ù„</h1>
        
        <div class="test-section">
            <h2>1. Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ PayPal SDK</h2>
            <button class="test-button" onclick="testSDKLoad()">Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ SDK</button>
            <div id="sdk-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ø¨Ù€ PayPal</h2>
            <button class="test-button" onclick="testPayPalPayment()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ</button>
            <div id="paypal-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h2>
            <button class="test-button" onclick="testCardPayment()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
            <div id="card-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. Ø§Ø®ØªØ¨Ø§Ø± ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ¯ÙÙ‚</h2>
            <button class="test-button" onclick="testCompleteFlow()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„</button>
            <div id="complete-result" class="result"></div>
        </div>
    </div>

    <script>
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ postMessage
        window.addEventListener('error', function(event) {
            if (event.message && event.message.includes('postMessage')) {
                console.warn('âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ postMessage Ù…Ù† PayPal SDK');
                event.preventDefault();
                return false;
            }
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && event.reason.message.includes('postMessage')) {
                console.warn('âš ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Promise rejection Ù…Ù† PayPal SDK');
                event.preventDefault();
                return false;
            }
        });

        // Ù…Ø­Ø§ÙƒØ§Ø© PayPalService
        class PayPalService {
            static CLIENT_ID = 'AcNsW7s0g8FV5sp4fjaOn5njkd7XOx4uDVplDRTJ4E37pPvs7YrAG6LMGcQP3I6PX4zTtxoz-hZf35pM'; // Sandbox Client ID
            static SDK_URL = `https://www.paypal.com/sdk/js?client-id=${PayPalService.CLIENT_ID}&currency=USD&intent=capture&components=buttons&enable-funding=card,credit&disable-funding=venmo,paylater`;

            static diagnoseSDKIssues() {
                console.log('ğŸ” ØªØ´Ø®ÙŠØµ Ù…Ø´Ø§ÙƒÙ„ PayPal SDK...');
                console.log('ğŸŒ Navigator online:', navigator.onLine);
                console.log('ğŸ”— Client ID:', PayPalService.CLIENT_ID);
                console.log('ğŸ“ SDK URL:', PayPalService.SDK_URL);
                
                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€ PayPal
                fetch('https://www.paypal.com/sdk/js', { method: 'HEAD', mode: 'no-cors' })
                    .then(() => console.log('âœ… ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø®Ø§Ø¯Ù… PayPal'))
                    .catch(err => console.error('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø®Ø§Ø¯Ù… PayPal:', err));
            }

            static async loadSDK() {
                return new Promise((resolve, reject) => {
                    try {
                        if (window.paypal) {
                            console.log('âœ… PayPal SDK Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                            resolve(true);
                            return;
                        }

                        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                        const existing = document.querySelectorAll('script[src*="paypal.com/sdk/js"]');
                        existing.forEach(s => {
                            try {
                                s.parentElement?.removeChild(s);
                            } catch (e) {
                                console.warn('ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ø³ÙƒØ±Ø¨Øª PayPal Ø³Ø§Ø¨Ù‚');
                            }
                        });

                        const script = document.createElement('script');
                        script.src = PayPalService.SDK_URL;
                        script.async = true;
                        script.crossOrigin = 'anonymous';
                        
                        // Ø¥Ø¶Ø§ÙØ© timeout
                        const timeout = setTimeout(() => {
                            reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ØªØ­Ù…ÙŠÙ„ PayPal SDK (15 Ø«Ø§Ù†ÙŠØ©)'));
                        }, 15000);

                        script.onload = () => {
                            clearTimeout(timeout);
                            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±Ø¨Øª PayPal');
                            
                            let attempts = 0;
                            const maxAttempts = 50;
                            const interval = 200;

                            const check = () => {
                                attempts++;
                                try {
                                    if (window.paypal && window.paypal.Buttons) {
                                        console.log('âœ… PayPal SDK Ø¬Ø§Ù‡Ø²');
                                        resolve(true);
                                        return;
                                    }
                                } catch (e) {
                                    console.warn('ØªØ­Ø°ÙŠØ± Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ PayPal:', e.message);
                                }
                                
                                if (attempts >= maxAttempts) {
                                    reject(new Error('PayPal SDK Ù„Ù… ÙŠØªÙ‡ÙŠØ£ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„'));
                                    return;
                                }
                                setTimeout(check, interval);
                            };
                            
                            setTimeout(check, interval);
                        };

                        script.onerror = (error) => {
                            clearTimeout(timeout);
                            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ PayPal SDK:', error);
                            reject(new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ PayPal SDK'));
                        };

                        document.head.appendChild(script);
                        
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ loadSDK:', error);
                        reject(error);
                    }
                });
            }

            static createOrderData() {
                return {
                    intent: 'CAPTURE',
                    purchase_units: [{
                        amount: {
                            currency_code: 'USD',
                            value: '29.99'
                        },
                        description: 'Trading Bot Subscription Test'
                    }],
                    application_context: {
                        brand_name: 'Trading Bot Pro',
                        landing_page: 'BILLING',
                        user_action: 'PAY_NOW',
                        shipping_preference: 'NO_SHIPPING'
                    }
                };
            }
        }

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (element.textContent) {
                element.textContent += logMessage;
            } else {
                element.textContent = logMessage;
            }
            
            element.className = `result ${type}`;
            element.scrollTop = element.scrollHeight;
        }

        async function testSDKLoad() {
            const resultId = 'sdk-result';
            log(resultId, 'ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ PayPal SDK...');
            
            // ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹
            PayPalService.diagnoseSDKIssues();
            
            try {
                const success = await PayPalService.loadSDK();
                if (success && window.paypal) {
                    log(resultId, 'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ PayPal SDK Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    log(resultId, `ğŸ“Š Ù…Ø­ØªÙˆÙŠØ§Øª window.paypal: ${Object.keys(window.paypal).join(', ')}`);
                    log(resultId, `ğŸ” Orders API Ù…ØªØ§Ø­: ${!!window.paypal.Orders}`);
                    log(resultId, `ğŸ” Buttons API Ù…ØªØ§Ø­: ${!!window.paypal.Buttons}`);
                } else {
                    log(resultId, 'âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ PayPal SDK', 'error');
                }
            } catch (error) {
                log(resultId, `âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        async function testPayPalPayment() {
            const resultId = 'paypal-result';
            log(resultId, 'ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ...');
            
            try {
                if (!window.paypal) {
                    await PayPalService.loadSDK();
                }

                const orderData = PayPalService.createOrderData();
                log(resultId, 'ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                log(resultId, `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${orderData.purchase_units[0].amount.value} ${orderData.purchase_units[0].amount.currency_code}`);
                log(resultId, `ğŸš« Ø§Ù„Ø´Ø­Ù†: ${orderData.application_context.shipping_preference}`);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø±
                const buttonsContainer = document.createElement('div');
                buttonsContainer.id = 'paypal-buttons-test';
                buttonsContainer.style.marginTop = '15px';
                document.getElementById(resultId).appendChild(buttonsContainer);

                const buttons = window.paypal.Buttons({
                    createOrder: (data, actions) => {
                        return actions.order.create(orderData);
                    },
                    onApprove: async (data, actions) => {
                        try {
                            const capture = await actions.order.capture();
                            log(resultId, 'âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                            log(resultId, `ğŸ†” Order ID: ${capture.id}`);
                            log(resultId, `ğŸ’³ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${capture.purchase_units[0].payments.captures[0].amount.value}`);
                            buttonsContainer.remove();
                        } catch (err) {
                            log(resultId, `âŒ ÙØ´Ù„ ÙÙŠ capture: ${err.message}`, 'error');
                        }
                    },
                    onCancel: () => {
                        log(resultId, 'âš ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
                        buttonsContainer.remove();
                    },
                    onError: (err) => {
                        log(resultId, `âŒ Ø®Ø·Ø£ ÙÙŠ PayPal: ${err.message || err}`, 'error');
                        buttonsContainer.remove();
                    }
                });

                if (buttons && buttons.render) {
                    await buttons.render('#paypal-buttons-test');
                    log(resultId, 'âœ… ØªÙ… Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± PayPal Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    log(resultId, 'âŒ ÙØ´Ù„ ÙÙŠ Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± PayPal', 'error');
                }

            } catch (error) {
                log(resultId, `âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        async function testCardPayment() {
            const resultId = 'card-result';
            log(resultId, 'ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...');
            
            try {
                if (!window.paypal) {
                    await PayPalService.loadSDK();
                }

                log(resultId, 'ğŸ’³ Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...', 'info');
                log(resultId, 'ğŸ“ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŒ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ù‡Ø§ØªÙ');
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹
                setTimeout(() => {
                    const mockTransactionId = 'CARD_' + Math.random().toString(36).substr(2, 9).toUpperCase();
                    log(resultId, 'âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­ (Ù…Ø­Ø§ÙƒØ§Ø©)', 'success');
                    log(resultId, `ğŸ†” Transaction ID: ${mockTransactionId}`);
                    log(resultId, `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: 29.99 USD`);
                    log(resultId, `ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: card-payment@example.com`);
                }, 2000);

            } catch (error) {
                log(resultId, `âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        async function testCompleteFlow() {
            const resultId = 'complete-result';
            log(resultId, 'ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„...');
            
            try {
                // 1. ØªØ­Ù…ÙŠÙ„ SDK
                log(resultId, '1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ù…ÙŠÙ„ SDK...');
                await PayPalService.loadSDK();
                log(resultId, 'âœ… SDK ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­');

                // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
                log(resultId, '2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨...');
                const orderData = PayPalService.createOrderData();
                log(resultId, 'âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø©');

                // 3. ÙØ­Øµ APIs
                log(resultId, '3ï¸âƒ£ ÙØ­Øµ APIs Ø§Ù„Ù…ØªØ§Ø­Ø©...');
                log(resultId, `Orders API: ${window.paypal.Orders ? 'âœ…' : 'âŒ'}`);
                log(resultId, `Buttons API: ${window.paypal.Buttons ? 'âœ…' : 'âŒ'}`);
                log(resultId, `Funding: ${window.paypal.FUNDING ? 'âœ…' : 'âŒ'}`);

                // 4. Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                if (window.paypal.Orders) {
                    log(resultId, '4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Orders API...');
                    // Ù‡Ø°Ø§ Ø³ÙŠØªØ·Ù„Ø¨ client-side tokenØŒ Ù„Ø°Ø§ Ù†ØªØ®Ø·Ø§Ù‡ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    log(resultId, 'âš ï¸ Orders API ÙŠØªØ·Ù„Ø¨ server-side implementation');
                }

                // 5. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                log(resultId, '5ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Buttons API...');
                if (window.paypal.Buttons) {
                    log(resultId, 'âœ… Buttons API Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
                } else {
                    log(resultId, 'âŒ Buttons API ØºÙŠØ± Ù…ØªØ§Ø­');
                }

                log(resultId, 'ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                log(resultId, 'ğŸ’¡ Ø§Ù„Ù†ØµÙŠØ­Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙØ±Ø¯ÙŠØ©');

            } catch (error) {
                log(resultId, `âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„: ${error.message}`, 'error');
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = () => {
            console.log('ğŸš€ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± PayPal Ø¬Ø§Ù‡Ø²Ø©');
        };
    </script>
</body>
</html>
