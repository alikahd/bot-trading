# ๐ ุชุนูููุงุช ุงูุฅุนุฏุงุฏ ูุงูุชูููุฐ - ุฎุทูุฉ ุจุฎุทูุฉ

## ๐ **ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ**

ูุจู ุงูุจุฏุกุ ุชุฃูุฏ ูู ุชููุฑ:
- โ ุญุณุงุจ Supabase ูุดุท
- โ ูุดุฑูุน Supabase ููุฌูุฏ
- โ ุงููุตูู ุฅูู ููุญุฉ ุชุญูู Supabase

---

## ๐ง **ุงูุฎุทูุฉ 1: ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช**

### 1.1 ุชูููุฐ SQL Script

1. ุงูุชุญ ููุญุฉ ุชุญูู Supabase
2. ุงุฐูุจ ุฅูู **SQL Editor**
3. ุงููุฑ ุนูู **New Query**
4. ุงูุชุญ ููู `database_setup.sql`
5. ุงูุณุฎ ุงููุญุชูู ุจุงููุงูู
6. ุงูุตูู ูู SQL Editor
7. ุงููุฑ ุนูู **Run** ุฃู ุงุถุบุท `Ctrl + Enter`

### 1.2 ุงูุชุญูู ูู ูุฌุงุญ ุงูุชูููุฐ

ุชุญูู ูู ุฅูุดุงุก ุงูุฌุฏุงูู:
```sql
-- ูู SQL Editorุ ููุฐ ูุฐุง ุงูุงุณุชุนูุงู:
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;
```

ูุฌุจ ุฃู ุชุฑู:
- โ `users`
- โ `subscription_plans`
- โ `subscriptions`
- โ `payments`

### 1.3 ุงูุชุญูู ูู ุงูุฏูุงู

```sql
-- ุชุญูู ูู ุงูุฏูุงู ุงูููุดุฃุฉ:
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public'
ORDER BY routine_name;
```

ูุฌุจ ุฃู ุชุฑู:
- โ `get_all_subscriptions_admin`
- โ `get_all_payments_with_details`
- โ `update_payment_status_with_subscription`
- โ `get_payment_statistics`
- โ `update_updated_at_column`

---

## ๐ฆ **ุงูุฎุทูุฉ 2: ุฅุนุฏุงุฏ Storage**

### 2.1 ุฅูุดุงุก Bucket ููุตูุฑ

1. ูู ููุญุฉ ุชุญูู Supabaseุ ุงุฐูุจ ุฅูู **Storage**
2. ุงููุฑ ุนูู **Create Bucket**
3. ุงููุฃ ุงูุจูุงูุงุช:
   - **Name:** `payment-proofs`
   - **Public:** โ (ุงุชุฑููุง ุบูุฑ ูุญุฏุฏุฉ)
   - **File size limit:** 5 MB
   - **Allowed MIME types:** 
     - `image/jpeg`
     - `image/jpg`
     - `image/png`
     - `image/webp`
4. ุงููุฑ ุนูู **Create Bucket**

### 2.2 ุฅุนุฏุงุฏ Storage Policies

ูู **Storage** โ **Policies** โ `payment-proofs`:

#### Policy 1: ุงูุณูุงุญ ูููุณุชุฎุฏููู ุจุฑูุน ุตูุฑูู
```sql
CREATE POLICY "Users can upload own payment proofs"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'payment-proofs' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);
```

#### Policy 2: ุงูุณูุงุญ ูููุณุชุฎุฏููู ุจุนุฑุถ ุตูุฑูู
```sql
CREATE POLICY "Users can view own payment proofs"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'payment-proofs' 
  AND auth.uid()::text = (storage.foldername(name))[1]
);
```

#### Policy 3: ุงูุณูุงุญ ููุฃุฏูู ุจุนุฑุถ ุฌููุน ุงูุตูุฑ
```sql
CREATE POLICY "Admins can view all payment proofs"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'payment-proofs' 
  AND EXISTS (
    SELECT 1 FROM users 
    WHERE auth_id = auth.uid() AND role = 'admin'
  )
);
```

---

## ๐ **ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู RLS Policies**

### 3.1 ุงูุชุญูู ูู ุชูุนูู RLS

```sql
-- ุชุญูู ูู ุชูุนูู RLS ุนูู ุงูุฌุฏุงูู:
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('users', 'subscription_plans', 'subscriptions', 'payments');
```

ูุฌุจ ุฃู ุชููู `rowsecurity = true` ูุฌููุน ุงูุฌุฏุงูู.

### 3.2 ุนุฑุถ Policies ุงููุทุจูุฉ

```sql
-- ุนุฑุถ ุฌููุน ุงูู policies:
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

---

## ๐ค **ุงูุฎุทูุฉ 4: ุฅูุดุงุก ุญุณุงุจ ุงูุฃุฏูู**

### 4.1 ุงูุชุณุฌูู ูุฃุฏูู

1. ุงูุชุญ ุงูุชุทุจูู
2. ุณุฌู ุญุณุงุจ ุฌุฏูุฏ ุจุงุณุชุฎุฏุงู:
   - **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:** `hichamkhad00@gmail.com`
   - **ุงุณู ุงููุณุชุฎุฏู:** `admin`
   - **ุงูุงุณู ุงููุงูู:** `Admin`
   - **ูููุฉ ุงููุฑูุฑ:** (ุงุฎุชุฑ ูููุฉ ูุฑูุฑ ูููุฉ)

### 4.2 ุชุญุฏูุซ ุฏูุฑ ุงูุฃุฏูู ูุฏููุงู

ุจุนุฏ ุงูุชุณุฌููุ ููุฐ ูุฐุง ูู SQL Editor:

```sql
-- ุชุญุฏูุซ ุฏูุฑ ุงููุณุชุฎุฏู ุฅูู admin
UPDATE users 
SET role = 'admin',
    is_active = true,
    email_verified = true,
    status = 'active',
    subscription_status = 'active'
WHERE email = 'hichamkhad00@gmail.com';
```

---

## ๐งช **ุงูุฎุทูุฉ 5: ุงุฎุชุจุงุฑ ุงููุธุงู**

### 5.1 ุงุฎุชุจุงุฑ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ

1. **ุงูุชุณุฌูู:**
   - ุงูุชุญ ุตูุญุฉ ุงูุชุณุฌูู
   - ุฃุฏุฎู ุจูุงูุงุช ูุณุชุฎุฏู ุฌุฏูุฏ
   - ุชุญูู ูู ุฅูุดุงุก ุงูุณุฌู ูู ุฌุฏูู `users`
   - ุงูุญุงูุฉ ูุฌุจ ุฃู ุชููู: `pending_email_verification`

2. **ุชูุนูู ุงูุจุฑูุฏ:**
   - ุฃุฏุฎู ุฑูุฒ ุงูุชูุนูู
   - ุชุญูู ูู ุชุญุฏูุซ `email_verified = true`
   - ุงูุญุงูุฉ ูุฌุจ ุฃู ุชุชุบูุฑ ุฅูู: `pending_subscription`

3. **ุงุฎุชูุงุฑ ุจุงูุฉ:**
   - ุงุฎุชุฑ ุจุงูุฉ ุงุดุชุฑุงู
   - ุชุญูู ูู ุญูุธ ุงูุจูุงูุงุช

### 5.2 ุงุฎุชุจุงุฑ ุงูุฏูุน ุจู PayPal

1. **ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน:** PayPal
2. **ุฃููู ุงูุฏูุน** (ุงุณุชุฎุฏู sandbox ููุงุฎุชุจุงุฑ)
3. **ุชุญูู ูู:**
   - โ ุฅูุดุงุก ุณุฌู ูู `payments` ุจุญุงูุฉ `completed`
   - โ ุฅูุดุงุก ุณุฌู ูู `subscriptions` ุจุญุงูุฉ `active`
   - โ ุชุญุฏูุซ `users`:
     - `is_active = true`
     - `status = 'active'`
     - `subscription_status = 'active'`
4. **ุฌุฑุจ ุชุณุฌูู ุงูุฏุฎูู** โ ูุฌุจ ุฃู ููุฌุญ โ

### 5.3 ุงุฎุชุจุงุฑ ุงูุฏูุน ุจุงูุนููุงุช ุงูุฑูููุฉ

1. **ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน:** Bitcoin/Crypto
2. **ุงุฑูุน ุตูุฑุฉ ุฅุซุจุงุช ุงูุฏูุน**
3. **ุชุญูู ูู:**
   - โ ุฅูุดุงุก ุณุฌู ูู `payments`:
     - `status = 'reviewing'`
     - `admin_review_status = 'pending'`
     - `crypto_proof_image` ูุญุชูู ุนูู ุฑุงุจุท ุงูุตูุฑุฉ
   - โ ุชุญุฏูุซ `users`:
     - `status = 'payment_pending_review'`
     - `is_active = false`
4. **ุฌุฑุจ ุชุณุฌูู ุงูุฏุฎูู** โ ูุฌุจ ุฃู ููุฑูุถ โ
   - ุฑุณุงูุฉ: "ุฏูุนุชู ููุฏ ุงููุฑุงุฌุนุฉ ูู ูุจู ุงูุฅุฏุงุฑุฉ"

### 5.4 ุงุฎุชุจุงุฑ ูุฑุงุฌุนุฉ ุงูุฃุฏูู

1. **ุณุฌู ุฏุฎูู ูุฃุฏูู**
2. **ุงูุชุญ ููุญุฉ ุงูุฅุฏุงุฑุฉ**
3. **ุงุฐูุจ ุฅูู ูุณู ุงููุฏููุนุงุช**
4. **ูุฌุจ ุฃู ุชุฑู ุงูุฏูุน ุงููุนูู**
5. **ุงุถุบุท ุนูู "ููุงููุฉ"**
6. **ุชุญูู ูู:**
   - โ ุชุญุฏูุซ `payments`:
     - `status = 'completed'`
     - `admin_review_status = 'approved'`
   - โ ุชุญุฏูุซ `subscriptions`:
     - `status = 'active'`
   - โ ุชุญุฏูุซ `users`:
     - `is_active = true`
     - `status = 'active'`
     - `subscription_status = 'active'`
7. **ุงููุณุชุฎุฏู ุงูุขู ููููู ุชุณุฌูู ุงูุฏุฎูู** โ

### 5.5 ุงุฎุชุจุงุฑ ุฑูุถ ุงูุฏูุน

1. **ูุฑุฑ ุฎุทูุงุช ุงูุฏูุน ุจุงูุนููุงุช ุงูุฑูููุฉ**
2. **ูู ููุญุฉ ุงูุฃุฏููุ ุงุถุบุท ุนูู "ุฑูุถ"**
3. **ุชุญูู ูู:**
   - โ ุชุญุฏูุซ `payments`:
     - `status = 'failed'`
     - `admin_review_status = 'rejected'`
   - โ ุชุญุฏูุซ `subscriptions`:
     - `status = 'cancelled'`
   - โ ุชุญุฏูุซ `users`:
     - `is_active = false`
     - `status = 'pending_payment'`
4. **ุงููุณุชุฎุฏู ูุง ููููู ุชุณุฌูู ุงูุฏุฎูู** โ

---

## ๐ **ุงูุฎุทูุฉ 6: ุงูุชุญูู ูู ุงูุฃูุงู**

### 6.1 ุงุฎุชุจุงุฑ RLS

```sql
-- ุฌุฑุจ ุงููุตูู ููุณุชุฎุฏู ุนุงุฏู:
SET ROLE authenticated;
SET request.jwt.claim.sub = '<user_auth_id>';

-- ูุฌุจ ุฃู ุชุฑู ุจูุงูุงุช ุงููุณุชุฎุฏู ููุท:
SELECT * FROM users;
SELECT * FROM subscriptions;
SELECT * FROM payments;

-- ุงูุนูุฏุฉ ููุฏูุฑ ุงูุงูุชุฑุงุถู:
RESET ROLE;
```

### 6.2 ุงุฎุชุจุงุฑ ููุน ุงููุตูู

1. **ุญุงูู ุชุณุฌูู ุฏุฎูู ุจุฏูู ุงุดุชุฑุงู** โ ูุฌุจ ุฃู ููุฑูุถ
2. **ุญุงูู ุชุณุฌูู ุฏุฎูู ุจุจุฑูุฏ ุบูุฑ ููุนู** โ ูุฌุจ ุฃู ููุฑูุถ
3. **ุญุงูู ุงููุตูู ูุจูุงูุงุช ูุณุชุฎุฏู ุขุฎุฑ** โ ูุฌุจ ุฃู ููุฑูุถ

---

## ๐ **ุงูุฎุทูุฉ 7: ูุฑุงูุจุฉ ุงููุธุงู**

### 7.1 ุงุณุชุนูุงูุงุช ูููุฏุฉ

```sql
-- ุนุฏุฏ ุงููุณุชุฎุฏููู ุญุณุจ ุงูุญุงูุฉ:
SELECT status, COUNT(*) 
FROM users 
GROUP BY status;

-- ุงููุฏููุนุงุช ุงููุนููุฉ:
SELECT COUNT(*) 
FROM payments 
WHERE admin_review_status = 'pending';

-- ุงูุงุดุชุฑุงูุงุช ุงููุดุทุฉ:
SELECT COUNT(*) 
FROM subscriptions 
WHERE status = 'active' 
AND end_date > NOW();

-- ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช:
SELECT SUM(amount) 
FROM payments 
WHERE status = 'completed';
```

### 7.2 ุชูุจููุงุช ูููุฉ

ุฑุงูุจ:
- โ๏ธ ุงููุฏููุนุงุช ุงููุนููุฉ ูุฃูุซุฑ ูู 24 ุณุงุนุฉ
- โ๏ธ ุงูุงุดุชุฑุงูุงุช ุงููุฑูุจุฉ ูู ุงูุงูุชูุงุก
- โ๏ธ ูุญุงููุงุช ุชุณุฌูู ุฏุฎูู ูุงุดูุฉ ูุชูุฑุฑุฉ

---

## ๐ **ุงุณุชูุดุงู ุงูุฃุฎุทุงุก**

### ูุดููุฉ: ูุง ูููู ุชุณุฌูู ุงูุฏุฎูู

**ุงูุญู:**
```sql
-- ุชุญูู ูู ุญุงูุฉ ุงููุณุชุฎุฏู:
SELECT 
    username, 
    email, 
    is_active, 
    email_verified, 
    status, 
    subscription_status
FROM users 
WHERE email = 'user@example.com';
```

### ูุดููุฉ: ุงูุตูุฑ ูุง ุชูุฑูุน

**ุงูุญู:**
1. ุชุญูู ูู ุฅูุดุงุก bucket `payment-proofs`
2. ุชุญูู ูู Storage Policies
3. ุชุญูู ูู ุญุฌู ุงูููู (ุฃูู ูู 5MB)
4. ุชุญูู ูู ููุน ุงูููู (ุตูุฑุฉ)

### ูุดููุฉ: ุงูุฃุฏูู ูุง ูุฑู ุงููุฏููุนุงุช

**ุงูุญู:**
```sql
-- ุชุญูู ูู ุฏูุฑ ุงูุฃุฏูู:
SELECT role FROM users WHERE email = 'hichamkhad00@gmail.com';

-- ูุฌุจ ุฃู ูููู: role = 'admin'
```

---

## โ **ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ**

ูุจู ุงูุฅุทูุงูุ ุชุฃูุฏ ูู:

### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- [ ] ุชูููุฐ `database_setup.sql` ุจูุฌุงุญ
- [ ] ุฌููุน ุงูุฌุฏุงูู ููุฌูุฏุฉ
- [ ] ุฌููุน ุงูุฏูุงู ููุฌูุฏุฉ
- [ ] RLS ููุนู ุนูู ุฌููุน ุงูุฌุฏุงูู
- [ ] Policies ูุทุจูุฉ ุจุดูู ุตุญูุญ

### Storage:
- [ ] Bucket `payment-proofs` ููุฌูุฏ
- [ ] Storage Policies ูุทุจูุฉ
- [ ] ูููู ุฑูุน ุงูุตูุฑ ุจูุฌุงุญ

### ุงูุฃุฏูู:
- [ ] ุญุณุงุจ ุงูุฃุฏูู ููุฌูุฏ
- [ ] ุฏูุฑ ุงูุฃุฏูู ุตุญูุญ (`role = 'admin'`)
- [ ] ูููู ุงููุตูู ูููุญุฉ ุงูุฅุฏุงุฑุฉ

### ุงูุงุฎุชุจุงุฑุงุช:
- [ ] ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ ูุนูู
- [ ] ุชูุนูู ุงูุจุฑูุฏ ูุนูู
- [ ] ุงุฎุชูุงุฑ ุจุงูุฉ ูุนูู
- [ ] ุงูุฏูุน ุจู PayPal ูุนูู
- [ ] ุงูุฏูุน ุจุงูุนููุงุช ุงูุฑูููุฉ ูุนูู
- [ ] ุฑูุน ุตูุฑ ุฅุซุจุงุช ุงูุฏูุน ูุนูู
- [ ] ูุฑุงุฌุนุฉ ุงูุฃุฏูู ุชุนูู
- [ ] ุชุณุฌูู ุงูุฏุฎูู ูุน ุงูุชุญูู ูุนูู
- [ ] ููุน ุงููุตูู ุจุฏูู ุงุดุชุฑุงู ูุนูู

---

## ๐ **ุงูุฏุนู ูุงููุณุงุนุฏุฉ**

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:

1. **ุฑุงุฌุน ุงููุซุงุฆู:**
   - `SUBSCRIPTION_FLOW_DOCUMENTATION.md`
   - `IMPLEMENTATION_SUMMARY.md`

2. **ุชุญูู ูู Logs:**
   - Console logs ูู ุงููุชุตูุญ
   - Supabase logs ูู Dashboard

3. **ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
   - ุงุณุชุฎุฏู SQL Editor ููุชุญูู ูู ุงูุจูุงูุงุช
   - ุฑุงุฌุน ุงูุงุณุชุนูุงูุงุช ุงููููุฏุฉ ุฃุนูุงู

---

**ุชู ุฅุนุฏุงุฏ ุงูุชุนูููุงุช ุจูุฌุงุญ! ๐**

**ููุงุญุธุฉ ูููุฉ:** ุงุญูุธ ูุฐู ุงููุนูููุงุช ูู ููุงู ุขููุ ุณุชุญุชุงุฌูุง ููุฑุฌูุน ุฅูููุง ูุงุญูุงู.
