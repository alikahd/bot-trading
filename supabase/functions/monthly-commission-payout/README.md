# ๐ Edge Function: ุงูุฏูุน ุงูุดูุฑู ุงูุชููุงุฆู ููุนูููุงุช

## ๐ ุงููุตู
ุฏุงูุฉ ุชููุงุฆูุฉ ุชุนูู ูู **ุงูููู ุงูุฃูู ูู ูู ุดูุฑ** ููุนุงูุฌุฉ ูุฏูุน ุงูุนูููุงุช ุงููุณุชุญูุฉ ูููุณุชุฎุฏููู.

## โ๏ธ ููู ูุนูู ุงููุธุงู

### 1. **ุงูุฌุฏููุฉ ุงูุชููุงุฆูุฉ**
```
ุงูุชูููุช: 1 ูู ูู ุดูุฑุ ุงูุณุงุนุฉ 00:00 UTC
ุงูุฌุฏููุฉ: 0 0 1 * *
```

### 2. **ุงูุชุฏูู ุงููุงูู**
```
Supabase Cron
    โ
Edge Function (index.ts)
    โ
Database Function (process_monthly_commissions)
    โ
ูุนุงูุฌุฉ ุงูุนูููุงุช + ุฅูุดุงุก ุงูุฅุดุนุงุฑุงุช
    โ
ุฅุฑุณุงู ุชูุฑูุฑ ููุฃุฏูู
```

### 3. **ุงููุนุงูุฌุฉ**
- โ ุฌูุจ ุฌููุน ุงูุนูููุงุช ุงููุนููุฉ (`status = 'pending'`)
- โ ุชุฌููุน ุงูุนูููุงุช ุญุณุจ ุงููุณุชุฎุฏู
- โ ุงูุชุญูู ูู ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ (ูู `referral_settings`)
- โ ุชุญุฏูุซ ุญุงูุฉ ุงูุนูููุงุช ุฅูู `paid`
- โ ุฅูุดุงุก ุณุฌูุงุช ูู `commission_payments`
- โ ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณุชุฎุฏููู
- โ ุฅุฑุณุงู ุชูุฑูุฑ ุดุงูู ููุฃุฏูู

## ๐ง ุงูุชุซุจูุช ูุงููุดุฑ

### 1. **ุชุทุจูู Database Migration**
```bash
# ุงูุงูุชูุงู ุฅูู ูุฌูุฏ ุงููุดุฑูุน
cd "c:\Users\Hicha\Downloads\bot trading\bot.ali"

# ุชุทุจูู Migration
supabase db push
```

### 2. **ูุดุฑ Edge Function**
```bash
# ูุดุฑ ุงูุฏุงูุฉ
supabase functions deploy monthly-commission-payout

# ุงูุชุญูู ูู ุงููุดุฑ
supabase functions list
```

### 3. **ุงูุชุญูู ูู Cron**
```bash
# ุนุฑุถ ุฌููุน Cron Jobs
supabase functions list --with-cron
```

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. **ุงุฎุชุจุงุฑ ูุฏูู**
```bash
# ุชุดุบูู ุงูุฏุงูุฉ ูุฏููุงู
supabase functions invoke monthly-commission-payout
```

### 2. **ุงุฎุชุจุงุฑ ูู ุงููุชุตูุญ**
```bash
# ุงูุญุตูู ุนูู URL ุงูุฏุงูุฉ
curl -X POST https://YOUR_PROJECT_REF.supabase.co/functions/v1/monthly-commission-payout \
  -H "Authorization: Bearer YOUR_ANON_KEY"
```

### 3. **ุงุฎุชุจุงุฑ Database Function ูุจุงุดุฑุฉ**
```sql
-- ูู Supabase SQL Editor
SELECT * FROM process_monthly_commissions();
```

### 4. **ุงูุญุตูู ุนูู ููุฎุต ุงูุนูููุงุช ุงููุนููุฉ**
```sql
SELECT * FROM get_pending_commissions_summary();
```

### 5. **ุงูุญุตูู ุนูู ุชูุฑูุฑ ุดูุฑู**
```sql
-- ุชูุฑูุฑ ุงูุดูุฑ ุงูุญุงูู
SELECT * FROM get_monthly_payout_report(CURRENT_DATE);

-- ุชูุฑูุฑ ุดูุฑ ูุญุฏุฏ
SELECT * FROM get_monthly_payout_report('2025-11-01');
```

## ๐ ูุซุงู ุนูู ุงููุชูุฌุฉ

### **ูุชูุฌุฉ ูุงุฌุญุฉ:**
```json
{
  "success": true,
  "message": "ุชู ูุนุงูุฌุฉ ุงูุฏูุน ุงูุดูุฑู ุจูุฌุงุญ",
  "summary": {
    "total_users": 5,
    "total_amount": 125.50,
    "successful_payouts": 5,
    "failed_payouts": 0
  },
  "details": [
    {
      "user_id": "uuid-1",
      "username": "ahmed",
      "email": "ahmed@example.com",
      "total_amount": 25.50,
      "commission_count": 3,
      "payment_method_type": "paypal",
      "success": true,
      "message": "ุชู ุงูุฏูุน ุจูุฌุงุญ"
    }
  ]
}
```

### **ูุง ุชูุฌุฏ ุนูููุงุช:**
```json
{
  "success": true,
  "message": "ุชู ูุนุงูุฌุฉ ุงูุฏูุน ุงูุดูุฑู ุจูุฌุงุญ",
  "summary": {
    "total_users": 0,
    "total_amount": 0,
    "successful_payouts": 0,
    "failed_payouts": 0
  },
  "details": [
    {
      "success": true,
      "message": "ูุง ุชูุฌุฏ ุนูููุงุช ูุณุชุญูุฉ ููุฏูุน (ุฃูู ูู ุงูุญุฏ ุงูุฃุฏูู $10)"
    }
  ]
}
```

## ๐ ุงูุฃูุงู

### **ุงูุตูุงุญูุงุช:**
- โ ููุท Supabase Cron ููููู ุชุดุบูู ุงูุฏุงูุฉ ุชููุงุฆูุงู
- โ ุงููุฏูุฑูู ูููููู ุชุดุบูููุง ูุฏููุงู
- โ Database Functions ุชุนูู ุจู `SECURITY DEFINER`

### **ุงูุญูุงูุฉ ูู ุงูุชูุฑุงุฑ:**
- โ ุฅุฐุง ุชู ุชุดุบูู ุงูุฏุงูุฉ ูุฑุชูู ูู ููุณ ุงูููู
- โ ูู ุชุฏูุน ุงูุนูููุงุช ูุฑุชูู
- โ ูุฃู `status` ุณูููู `paid` ุจุงููุนู

## ๐ง ุงูุฅุดุนุงุฑุงุช

### **ูููุณุชุฎุฏููู:**
```
๐ ุชู ุฏูุน ุนูููุงุชู ุงูุดูุฑูุฉ
ุชู ุฏูุน ุนูููุงุชู ุจูููุฉ $25.50 ุจูุฌุงุญ. ุดูุฑุงู ูู!
```

### **ููุฃุฏูู:**
```
๐ ุชูุฑูุฑ ุงูุฏูุน ุงูุดูุฑู - ููููุจุฑ 2025

โ ุชู ุฏูุน $125.50 ูู 5 ูุณุชุฎุฏููู

ุงูุชูุงุตูู:
1. ahmed - $25.50 (3 ุนูููุฉ)
2. sara - $30.00 (2 ุนูููุฉ)
3. mohammed - $20.00 (1 ุนูููุฉ)
4. fatima - $35.00 (4 ุนูููุฉ)
5. ali - $15.00 (2 ุนูููุฉ)
```

## ๐๏ธ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### **ุงููุดููุฉ: ุงูุฏุงูุฉ ูุง ุชุนูู ุชููุงุฆูุงู**
```bash
# ุงูุชุญูู ูู Cron
supabase functions list --with-cron

# ุงูุชุญูู ูู enabled = true ูู cron.toml
```

### **ุงููุดููุฉ: ุฎุทุฃ ูู ุงููุนุงูุฌุฉ**
```sql
-- ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงููุธุงู
SELECT * FROM referral_settings;

-- ุงูุชุญูู ูู ุงูุนูููุงุช ุงููุนููุฉ
SELECT * FROM get_pending_commissions_summary();
```

### **ุงููุดููุฉ: ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช**
```sql
-- ุงูุชุญูู ูู ุฌุฏูู ุงูุฅุดุนุงุฑุงุช
SELECT * FROM notifications 
WHERE type = 'commission_paid' 
ORDER BY created_at DESC 
LIMIT 10;
```

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ:**
   - ูุชู ุฌูุจู ูู `referral_settings.minimum_payout`
   - ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ: $10
   - ูููู ุชุบููุฑู ูู ููุญุฉ ุฅุนุฏุงุฏุงุช ูุธุงู ุงูุฅุญุงูุฉ

2. **ุฏูุฑุฉ ุงูุฏูุน:**
   - ุญุงููุงู: ุดูุฑูุงู (ุงูููู ุงูุฃูู)
   - ูููู ุชุนุฏูู `cron.toml` ูุชุบููุฑ ุงูุชูููุช

3. **ุทุฑู ุงูุฏูุน:**
   - ูุชู ุฌูุจูุง ูู `payment_methods` ุญูุซ `is_primary = true`
   - ุฅุฐุง ูู ูุญุฏุฏ ุงููุณุชุฎุฏู ุทุฑููุฉ ุฏูุนุ ูุชู ุชุณุฌูู `pending_setup`

4. **ุงูุณุฌูุงุช:**
   - ุฌููุน ุงูุนูููุงุช ูุณุฌูุฉ ูู `commission_payments`
   - ูููู ุงูุฑุฌูุน ุฅูููุง ูู ุฃู ููุช

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

- [ ] ุฅุถุงูุฉ ุฅุดุนุงุฑุงุช ุจุฑูุฏ ุฅููุชุฑููู
- [ ] ุฅุถุงูุฉ ุชูุงูู ูุน PayPal API ููุฏูุน ุงูุชููุงุฆู
- [ ] ุฅุถุงูุฉ ุชูุงุฑูุฑ PDF
- [ ] ุฅุถุงูุฉ ููุญุฉ ุชุญูู ููุฃุฏูู ูู ุงููุงุฌูุฉ

## ๐ ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุงุณุชูุณุงุฑุงุชุ ุฑุงุฌุน:
- [Supabase Edge Functions Docs](https://supabase.com/docs/guides/functions)
- [Supabase Cron Jobs](https://supabase.com/docs/guides/functions/schedule-functions)
