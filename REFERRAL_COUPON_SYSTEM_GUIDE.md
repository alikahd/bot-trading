# ๐ ุฏููู ูุธุงู ุงูุฅุญุงูุฉ ูุงูููุจููุงุช
## Referral & Coupon System Implementation Guide

---

## ๐ ุงููุญุชููุงุช

1. [ูุธุฑุฉ ุนุงูุฉ](#ูุธุฑุฉ-ุนุงูุฉ)
2. [ุฎุทูุงุช ุงูุชูููุฐ](#ุฎุทูุงุช-ุงูุชูููุฐ)
3. [ูุงุนุฏุฉ ุงูุจูุงูุงุช](#ูุงุนุฏุฉ-ุงูุจูุงูุงุช)
4. [ุงูููููุงุช](#ุงูููููุงุช)
5. [ููููุฉ ุงูุงุณุชุฎุฏุงู](#ููููุฉ-ุงูุงุณุชุฎุฏุงู)
6. [ุงูุฃูุงู](#ุงูุฃูุงู)

---

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ููุฅุญุงูุฉ ูุงูููุจููุงุช ูุชุถูู:

### โจ ููุฒุงุช ูุธุงู ุงูุฅุญุงูุฉ:
- โ ููุฏ ุฅุญุงูุฉ ูุฑูุฏ ููู ูุณุชุฎุฏู
- โ ุฑุงุจุท ุฅุญุงูุฉ ูุงุจู ูููุดุงุฑูุฉ
- โ ุชุชุจุน ุงูุฅุญุงูุงุช (pending, completed, rewarded)
- โ ูุธุงู ููุงูุขุช ูุงุจู ููุชุฎุตูุต
- โ ุตูุญุฉ ุฅุญุตุงุฆูุงุช ููุตูุฉ

### ๐ซ ููุฒุงุช ูุธุงู ุงูููุจููุงุช:
- โ ุฅูุดุงุก ููุจููุงุช ุจููุนูู (ูุณุจุฉ ูุฆููุฉ / ูุจูุบ ุซุงุจุช)
- โ ุชุญุฏูุฏ ุนุฏุฏ ุงุณุชุฎุฏุงูุงุช ูุญุฏูุฏ ุฃู ุบูุฑ ูุญุฏูุฏ
- โ ุชุงุฑูุฎ ุงูุชูุงุก ุตูุงุญูุฉ
- โ ุชุชุจุน ุงูุงุณุชุฎุฏุงูุงุช
- โ ููุญุฉ ุชุญูู ูููุฏูุฑ

---

## ๐ ุฎุทูุงุช ุงูุชูููุฐ

### ุงูุฎุทูุฉ 1: ุชูููุฐ ูุงุนุฏุฉ ุงูุจูุงูุงุช

1. ุงูุชุญ **Supabase Dashboard**
2. ุงุฐูุจ ุฅูู **SQL Editor**
3. ุงูุชุญ ุงูููู: `supabase_migrations/referrals_and_coupons_system.sql`
4. ุงูุณุฎ ุงููุญุชูู ูุงูุตูู ูู SQL Editor
5. ุงุถุบุท **Run** ูุชูููุฐ ุงูู SQL

ูุฐุง ุณููุดุฆ:
- โ ุฌุฏูู `referrals` - ูุชุชุจุน ุงูุฅุญุงูุงุช
- โ ุฌุฏูู `coupons` - ูุฅุฏุงุฑุฉ ุงูููุจููุงุช
- โ ุฌุฏูู `coupon_usage` - ูุชุชุจุน ุงุณุชุฎุฏุงู ุงูููุจููุงุช
- โ ุนููุฏ `referral_code` ูู ุฌุฏูู `users`
- โ ุฏูุงู ุชููุงุฆูุฉ ูุชูููุฏ ุฃููุงุฏ ุงูุฅุญุงูุฉ
- โ ุณูุงุณุงุช ุงูุฃูุงู (RLS Policies)

### ุงูุฎุทูุฉ 2: ุฅุถุงูุฉ ุตูุญุฉ ุงูุฅุญุงูุฉ ูู ููุญุฉ ุงูุชุญูู

ูู ููู `App.tsx`ุ ุฃุถู:

```typescript
import { ReferralPanel } from './components/referral/ReferralPanel';

// ูู ููุงู ุนุฑุถ ุงูุชุจููุจุงุช
{activeTab === 'referral' && (
  <ReferralPanel 
    userId={user.id} 
    userEmail={user.email} 
  />
)}
```

### ุงูุฎุทูุฉ 3: ุฅุถุงูุฉ ุฅุฏุงุฑุฉ ุงูููุจููุงุช ูููุฏูุฑ

ูู ููุญุฉ ุชุญูู ุงููุฏูุฑ:

```typescript
import { CouponManagement } from './components/admin/CouponManagement';

// ูู ุตูุญุฉ ุงููุฏูุฑ
<CouponManagement />
```

### ุงูุฎุทูุฉ 4: ุฅุถุงูุฉ ุญูู ุงูููุจูู ูู ุตูุญุฉ ุงูุฏูุน

ูู `PaymentPage.tsx`:

```typescript
import { CouponField } from './components/payments/CouponField';

const [discount, setDiscount] = useState(0);
const [couponId, setCouponId] = useState('');

// ูู ูููุฐุฌ ุงูุฏูุน
<CouponField
  originalPrice={selectedPlan.price}
  onCouponApplied={(discountAmount, id) => {
    setDiscount(discountAmount);
    setCouponId(id);
  }}
  userId={user.id}
/>

// ุนุฑุถ ุงูุณุนุฑ ุงูููุงุฆู
const finalPrice = selectedPlan.price - discount;
```

### ุงูุฎุทูุฉ 5: ูุนุงูุฌุฉ ุงูุฅุญุงูุฉ ุนูุฏ ุงูุชุณุฌูู

ูู `RegisterPage.tsx`:

```typescript
// ุงุณุชุฎุฑุงุฌ ููุฏ ุงูุฅุญุงูุฉ ูู URL
const urlParams = new URLSearchParams(window.location.search);
const refCode = urlParams.get('ref');

// ุนูุฏ ุงูุชุณุฌูู ุงููุงุฌุญ
if (refCode) {
  await supabase.from('referrals').insert({
    referrer_id: (await supabase
      .from('users')
      .select('id')
      .eq('referral_code', refCode)
      .single()).data?.id,
    referred_email: email,
    referral_code: refCode,
    status: 'pending'
  });
}
```

### ุงูุฎุทูุฉ 6: ุชุญุฏูุซ ุญุงูุฉ ุงูุฅุญุงูุฉ ุนูุฏ ุงูุงุดุชุฑุงู

ุนูุฏ ุฅุชูุงู ุงูุฏูุน ุจูุฌุงุญ:

```typescript
// ูู onPaymentComplete
const { data: referral } = await supabase
  .from('referrals')
  .select('*')
  .eq('referred_email', user.email)
  .eq('status', 'pending')
  .single();

if (referral) {
  await supabase
    .from('referrals')
    .update({
      referred_user_id: user.id,
      status: 'completed',
      completed_at: new Date().toISOString(),
      reward_amount: 10 // ุงูููุงูุฃุฉ
    })
    .eq('id', referral.id);
}
```

### ุงูุฎุทูุฉ 7: ุญูุธ ุงุณุชุฎุฏุงู ุงูููุจูู

ุนูุฏ ุฅุชูุงู ุงูุฏูุน ุจููุจูู:

```typescript
if (couponId) {
  // ุญูุธ ุงุณุชุฎุฏุงู ุงูููุจูู
  await supabase.from('coupon_usage').insert({
    coupon_id: couponId,
    user_id: user.id,
    discount_applied: discount
  });

  // ุชุญุฏูุซ ุนุฏุฏ ุงูุงุณุชุฎุฏุงูุงุช
  await supabase.rpc('increment_coupon_usage', {
    coupon_id: couponId
  });
}
```

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู `referrals`

| ุงูุนููุฏ | ุงูููุน | ุงููุตู |
|--------|------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| referrer_id | UUID | ูุนุฑู ุงูููุญูู |
| referred_user_id | UUID | ูุนุฑู ุงููุณุชุฎุฏู ุงูููุญุงู |
| referral_code | VARCHAR(20) | ููุฏ ุงูุฅุญุงูุฉ |
| referred_email | VARCHAR(255) | ุจุฑูุฏ ุงููุณุชุฎุฏู ุงูููุญุงู |
| status | VARCHAR(20) | ุงูุญุงูุฉ (pending/completed/rewarded) |
| reward_amount | DECIMAL(10,2) | ูุจูุบ ุงูููุงูุฃุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |
| completed_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅููุงู |

### ุฌุฏูู `coupons`

| ุงูุนููุฏ | ุงูููุน | ุงููุตู |
|--------|------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| code | VARCHAR(50) | ููุฏ ุงูููุจูู |
| discount_type | VARCHAR(20) | ููุน ุงูุฎุตู (percentage/fixed) |
| discount_value | DECIMAL(10,2) | ูููุฉ ุงูุฎุตู |
| max_uses | INTEGER | ุงูุญุฏ ุงูุฃูุตู ููุงุณุชุฎุฏุงูุงุช |
| current_uses | INTEGER | ุงูุงุณุชุฎุฏุงูุงุช ุงูุญุงููุฉ |
| valid_from | TIMESTAMP | ุชุงุฑูุฎ ุงูุจุฏุงูุฉ |
| valid_until | TIMESTAMP | ุชุงุฑูุฎ ุงูุงูุชูุงุก |
| is_active | BOOLEAN | ูุดุท/ุบูุฑ ูุดุท |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู `coupon_usage`

| ุงูุนููุฏ | ุงูููุน | ุงููุตู |
|--------|------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| coupon_id | UUID | ูุนุฑู ุงูููุจูู |
| user_id | UUID | ูุนุฑู ุงููุณุชุฎุฏู |
| discount_applied | DECIMAL(10,2) | ุงูุฎุตู ุงููุทุจู |
| used_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุงุณุชุฎุฏุงู |

---

## ๐จ ุงูููููุงุช

### 1. ReferralPanel
**ุงููุณุงุฑ**: `src/components/referral/ReferralPanel.tsx`

**ุงูุฎุตุงุฆุต**:
- `userId`: ูุนุฑู ุงููุณุชุฎุฏู
- `userEmail`: ุจุฑูุฏ ุงููุณุชุฎุฏู

**ุงูููุฒุงุช**:
- ุนุฑุถ ุฑุงุจุท ุงูุฅุญุงูุฉ
- ูุณุฎ ุงูุฑุงุจุท
- ูุดุงุฑูุฉ ุงูุฑุงุจุท
- ุฅุญุตุงุฆูุงุช ุงูุฅุญุงูุงุช
- ูุงุฆูุฉ ุงูุฅุญุงูุงุช

### 2. CouponManagement
**ุงููุณุงุฑ**: `src/components/admin/CouponManagement.tsx`

**ุงูููุฒุงุช**:
- ุฅูุดุงุก ููุจููุงุช ุฌุฏูุฏุฉ
- ุชุนุฏูู ุงูููุจููุงุช
- ุญุฐู ุงูููุจููุงุช
- ุชูุนูู/ุฅูุบุงุก ุชูุนูู
- ุฅุญุตุงุฆูุงุช ุงูููุจููุงุช

### 3. CouponField
**ุงููุณุงุฑ**: `src/components/payments/CouponField.tsx`

**ุงูุฎุตุงุฆุต**:
- `originalPrice`: ุงูุณุนุฑ ุงูุฃุตูู
- `onCouponApplied`: ุฏุงูุฉ ุนูุฏ ุชุทุจูู ุงูููุจูู
- `userId`: ูุนุฑู ุงููุณุชุฎุฏู

**ุงูููุฒุงุช**:
- ุฅุฏุฎุงู ููุฏ ุงูููุจูู
- ุงูุชุญูู ูู ุตุญุฉ ุงูููุจูู
- ุญุณุงุจ ุงูุฎุตู
- ุนุฑุถ ุงูููุจูู ุงููุทุจู

---

## ๐ก ููููุฉ ุงูุงุณุชุฎุฏุงู

### ูููุณุชุฎุฏููู:

#### 1. ุงูุญุตูู ุนูู ุฑุงุจุท ุงูุฅุญุงูุฉ:
1. ุณุฌู ุงูุฏุฎูู
2. ุงุฐูุจ ุฅูู ุชุจููุจ "ุงูุฅุญุงูุฉ"
3. ุงูุณุฎ ุฑุงุจุท ุงูุฅุญุงูุฉ
4. ุดุงุฑูู ูุน ุฃุตุฏูุงุฆู

#### 2. ุงุณุชุฎุฏุงู ููุจูู ุฎุตู:
1. ูู ุตูุญุฉ ุงูุฏูุน
2. ุฃุฏุฎู ููุฏ ุงูููุจูู
3. ุงุถุบุท "ุชุทุจูู"
4. ุณูุชู ุชุทุจูู ุงูุฎุตู ุชููุงุฆูุงู

### ูููุฏูุฑ:

#### 1. ุฅูุดุงุก ููุจูู:
1. ุงุฐูุจ ุฅูู "ุฅุฏุงุฑุฉ ุงูููุจููุงุช"
2. ุงุถุบุท "ุฅุถุงูุฉ ููุจูู ุฌุฏูุฏ"
3. ุงููุฃ ุงูุจูุงูุงุช:
   - ุงูููุฏ (ูุซู: SUMMER2024)
   - ููุน ุงูุฎุตู (ูุณุจุฉ ุฃู ูุจูุบ ุซุงุจุช)
   - ูููุฉ ุงูุฎุตู
   - ุนุฏุฏ ุงูุงุณุชุฎุฏุงูุงุช (ุงุฎุชูุงุฑู)
   - ุชุงุฑูุฎ ุงูุงูุชูุงุก (ุงุฎุชูุงุฑู)
4. ุงุถุบุท "ุฅูุดุงุก"

#### 2. ุฅุฏุงุฑุฉ ุงูุฅุญุงูุงุช:
- ุนุฑุถ ุฌููุน ุงูุฅุญุงูุงุช
- ุชุญุฏูุซ ุญุงูุฉ ุงูุฅุญุงูุงุช
- ุชุนููู ุงูููุงูุขุช

---

## ๐ ุงูุฃูุงู

### Row Level Security (RLS)

ุชู ุชูุนูู RLS ุนูู ุฌููุน ุงูุฌุฏุงูู ูุน ุงูุณูุงุณุงุช ุงูุชุงููุฉ:

#### ุฌุฏูู `referrals`:
- โ ุงููุณุชุฎุฏู ูุฑู ุฅุญุงูุงุชู ููุท
- โ ุงููุณุชุฎุฏู ููููู ุฅูุดุงุก ุฅุญุงูุงุช
- โ ุงููุฏูุฑ ูุฑู ุฌููุน ุงูุฅุญุงูุงุช
- โ ุงููุฏูุฑ ููููู ุชุญุฏูุซ ุงูุฅุญุงูุงุช

#### ุฌุฏูู `coupons`:
- โ ุงูุฌููุน ูุฑูู ุงูููุจููุงุช ุงููุดุทุฉ
- โ ุงููุฏูุฑ ููุท ููููู ุฅูุดุงุก/ุชุนุฏูู/ุญุฐู ุงูููุจููุงุช

#### ุฌุฏูู `coupon_usage`:
- โ ุงููุณุชุฎุฏู ูุฑู ุงุณุชุฎุฏุงูุงุชู ููุท
- โ ุงููุณุชุฎุฏู ููููู ุชุณุฌูู ุงุณุชุฎุฏุงู
- โ ุงููุฏูุฑ ูุฑู ุฌููุน ุงูุงุณุชุฎุฏุงูุงุช

### ุงูุชุญููุงุช ุงูุฃูููุฉ:

1. **ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูููุจูู**:
   - ุงูููุจูู ูุดุท
   - ูู ููุชูู ุชุงุฑูุฎู
   - ูู ูุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ููุงุณุชุฎุฏุงูุงุช
   - ุงููุณุชุฎุฏู ูู ูุณุชุฎุฏูู ูู ูุจู

2. **ุงูุชุญูู ูู ุงูุฅุญุงูุฉ**:
   - ููุฏ ุงูุฅุญุงูุฉ ุตุญูุญ
   - ุงููุณุชุฎุฏู ูู ููุญุงู ูู ูุจู
   - ุงูููุญูู ููุฌูุฏ ููุดุท

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ูุงูุชูุงุฑูุฑ

### ูููุณุชุฎุฏููู:
- ุฅุฌูุงูู ุงูุฅุญุงูุงุช
- ุงูุฅุญุงูุงุช ุงูููุชููุฉ
- ุงูุฅุญุงูุงุช ููุฏ ุงูุงูุชุธุงุฑ
- ุฅุฌูุงูู ุงูููุงูุขุช

### ูููุฏูุฑ:
- ุฅุฌูุงูู ุงูููุจููุงุช
- ุงูููุจููุงุช ุงููุดุทุฉ
- ุงูููุจููุงุช ุงูููุชููุฉ
- ุฅุฌูุงูู ุงูุงุณุชุฎุฏุงูุงุช
- ุฅุฌูุงูู ุงูุฎุตููุงุช ุงููุทุจูุฉ

---

## ๐ฏ ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ุฅูุดุงุก ููุจูู ุฎุตู 20%

```sql
INSERT INTO coupons (code, discount_type, discount_value, max_uses, valid_until, is_active)
VALUES ('WELCOME20', 'percentage', 20, 100, '2024-12-31', true);
```

### ูุซุงู 2: ุฅูุดุงุก ููุจูู ุฎุตู $5

```sql
INSERT INTO coupons (code, discount_type, discount_value, is_active)
VALUES ('SAVE5', 'fixed', 5, true);
```

### ูุซุงู 3: ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงูุฅุญุงูุฉ

```sql
SELECT 
  COUNT(*) as total_referrals,
  COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed,
  COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending,
  SUM(reward_amount) as total_rewards
FROM referrals
WHERE referrer_id = 'USER_ID';
```

---

## ๐ ุงูุฏุนู ูุงููุณุงุนุฏุฉ

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:

1. ุชุญูู ูู ุฃู SQL ุชู ุชูููุฐู ุจูุฌุงุญ
2. ุชุฃูุฏ ูู ุชูุนูู RLS
3. ุฑุงุฌุน console logs ููุฃุฎุทุงุก
4. ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู

---

## โ ูุงุฆูุฉ ุงูุชุญูู

- [ ] ุชูููุฐ SQL ูู Supabase
- [ ] ุฅุถุงูุฉ ReferralPanel ูู ููุญุฉ ุงูุชุญูู
- [ ] ุฅุถุงูุฉ CouponManagement ูููุฏูุฑ
- [ ] ุฅุถุงูุฉ CouponField ูู ุตูุญุฉ ุงูุฏูุน
- [ ] ูุนุงูุฌุฉ ุงูุฅุญุงูุฉ ุนูุฏ ุงูุชุณุฌูู
- [ ] ุชุญุฏูุซ ุญุงูุฉ ุงูุฅุญุงูุฉ ุนูุฏ ุงูุงุดุชุฑุงู
- [ ] ุญูุธ ุงุณุชุฎุฏุงู ุงูููุจูู
- [ ] ุงุฎุชุจุงุฑ ุงููุธุงู ุจุงููุงูู

---

## ๐ ุชู ุจูุฌุงุญ!

ุงูุขู ูุฏูู ูุธุงู ุฅุญุงูุฉ ูููุจููุงุช ูุชูุงูู ูุฌุงูุฒ ููุงุณุชุฎุฏุงู!
