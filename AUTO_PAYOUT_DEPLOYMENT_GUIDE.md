# ๐ ุฏููู ูุดุฑ ูุธุงู ุงูุฏูุน ุงูุชููุงุฆู ุงูุดูุฑู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ููุฏูุน ุงูุชููุงุฆู ุงูุดูุฑู ููุนูููุงุช ูุนูู ูู **ุงูููู ุงูุฃูู ูู ูู ุดูุฑ** ูู ุงูุณุงุนุฉ 00:00 UTC.

---

## ๐ฆ ุงููููุงุช ุงููููุดุฃุฉ

### **1. Database Migration**
```
๐ supabase/migrations/20251102_process_monthly_commissions.sql
```
**ุงููุญุชูู:**
- โ `process_monthly_commissions()` - ุฏุงูุฉ ูุนุงูุฌุฉ ุงูุนูููุงุช
- โ `get_pending_commissions_summary()` - ููุฎุต ุงูุนูููุงุช ุงููุนููุฉ
- โ `get_monthly_payout_report()` - ุชูุฑูุฑ ุงูุฏูุนุงุช ุงูุดูุฑูุฉ

### **2. Edge Function**
```
๐ supabase/functions/monthly-commission-payout/
  โโโ index.ts          # ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ
  โโโ cron.toml         # ุฅุนุฏุงุฏุงุช ุงูุฌุฏููุฉ
  โโโ README.md         # ุฏููู ุงูุงุณุชุฎุฏุงู
```

### **3. Admin Panel Component**
```
๐ src/components/admin/AutoPayoutSettings.tsx
```
**ุงููููุฒุงุช:**
- ุนุฑุถ ุงูุนูููุงุช ุงููุนููุฉ
- ุชุดุบูู ุงูุฏูุน ุงููุฏูู
- ุนุฑุถ ุณุฌู ุงูุฏูุนุงุช ุงูุดูุฑูุฉ
- ุฅุญุตุงุฆูุงุช ููุตูุฉ

---

## ๐ง ุฎุทูุงุช ุงููุดุฑ

### **ุงูุฎุทูุฉ 1: ุชุทุจูู Database Migration**

```bash
# ุงูุงูุชูุงู ุฅูู ูุฌูุฏ ุงููุดุฑูุน
cd "c:\Users\Hicha\Downloads\bot trading\bot.ali"

# ุชุทุจูู Migration
supabase db push
```

**ุงูุชุญูู ูู ุงููุฌุงุญ:**
```sql
-- ูู Supabase SQL Editor
SELECT * FROM pg_proc WHERE proname = 'process_monthly_commissions';
```

---

### **ุงูุฎุทูุฉ 2: ูุดุฑ Edge Function**

```bash
# ูุดุฑ ุงูุฏุงูุฉ
supabase functions deploy monthly-commission-payout

# ุงูุชุญูู ูู ุงููุดุฑ
supabase functions list
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโโโ
โ Name                           โ Status  โ Cron       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโโโค
โ monthly-commission-payout      โ ACTIVE  โ 0 0 1 * *  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโโโ
```

---

### **ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู Cron Job**

```bash
# ุนุฑุถ ุฌููุน Cron Jobs
supabase functions list --with-cron
```

**ุงูุชุฃูุฏ ูู:**
- โ `enabled = true`
- โ `schedule = "0 0 1 * *"`
- โ `timezone = "UTC"`

---

### **ุงูุฎุทูุฉ 4: ุงุฎุชุจุงุฑ ุงููุธุงู**

#### **ุฃ. ุงุฎุชุจุงุฑ Database Function ูุจุงุดุฑุฉ:**
```sql
-- ูู Supabase SQL Editor
SELECT * FROM process_monthly_commissions();
```

#### **ุจ. ุงุฎุชุจุงุฑ Edge Function ูุฏููุงู:**
```bash
supabase functions invoke monthly-commission-payout
```

#### **ุฌ. ุงูุญุตูู ุนูู ููุฎุต ุงูุนูููุงุช:**
```sql
SELECT * FROM get_pending_commissions_summary();
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "total_users": 5,
  "total_amount": 125.50,
  "eligible_users": 3,
  "eligible_amount": 95.50,
  "minimum_payout": 10.00
}
```

---

## ๐ฏ ููู ูุนูู ุงููุธุงู

### **ุงูุชุฏูู ุงููุงูู:**

```
1๏ธโฃ ุงูููู ุงูุฃูู ูู ุงูุดูุฑุ ุงูุณุงุนุฉ 00:00 UTC
    โ
2๏ธโฃ Supabase Cron ูุณุชุฏุนู Edge Function
    โ
3๏ธโฃ Edge Function ุชุณุชุฏุนู process_monthly_commissions()
    โ
4๏ธโฃ Database Function:
    - ุชุฌูุน ุงูุนูููุงุช ุญุณุจ ุงููุณุชุฎุฏู
    - ุชุชุญูู ูู ุงูุญุฏ ุงูุฃุฏูู ($10)
    - ุชุญุฏุซ status = 'paid'
    - ุชูุดุฆ commission_payments
    - ุชุฑุฌุน ูุงุฆูุฉ ุงููุณุชุฎุฏููู
    โ
5๏ธโฃ Edge Function:
    - ุชูุดุฆ ุฅุดุนุงุฑุงุช ูููุณุชุฎุฏููู
    - ุชุฑุณู ุชูุฑูุฑ ููุฃุฏูู
    โ
6๏ธโฃ โ ุงูุชูุงู ุงูุนูููุฉ
```

---

## ๐ ููุญุฉ ุงูุชุญูู ููุฃุฏูู

### **ุงููุตูู:**
```
ููุญุฉ ุงูุชุญูู โ ุงูุฏูุน ุงูุชููุงุฆู
```

### **ุงููููุฒุงุช:**

#### **1. ููุฎุต ุงูุนูููุงุช ุงููุนููุฉ:**
- ุฅุฌูุงูู ุงููุจูุบ
- ุงููุคูู ููุฏูุน (โฅ $10)
- ุฃูู ูู ุงูุญุฏ ุงูุฃุฏูู
- ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ

#### **2. ุชุดุบูู ุงูุฏูุน ุงููุฏูู:**
```
ุฒุฑ: "ุชุดุบูู ุงูุฏูุน ุงููุฏูู ุงูุขู"
```
- ูููู ููุฃุฏูู ุชุดุบูู ุงูุฏูุน ูู ุฃู ููุช
- ูุง ูุญุชุงุฌ ุงูุชุธุงุฑ ุงูููู ุงูุฃูู ูู ุงูุดูุฑ

#### **3. ุณุฌู ุงูุฏูุนุงุช:**
- ุนุฑุถ ุขุฎุฑ 6 ุฃุดูุฑ
- ุชูุงุตูู ูู ุฏูุนุฉ
- ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุฏููุน ููู

---

## ๐ ุงูุฃูุงู

### **ุงูุตูุงุญูุงุช:**
- โ ููุท Supabase Cron ููููู ุชุดุบูู Edge Function ุชููุงุฆูุงู
- โ ุงููุฏูุฑูู ูููููู ุชุดุบูููุง ูุฏููุงู ูู ููุญุฉ ุงูุชุญูู
- โ Database Functions ุชุนูู ุจู `SECURITY DEFINER`

### **ุงูุญูุงูุฉ ูู ุงูุชูุฑุงุฑ:**
- โ ุฅุฐุง ุชู ุชุดุบูู ุงูุฏุงูุฉ ูุฑุชูู ูู ููุณ ุงูููู
- โ ูู ุชุฏูุน ุงูุนูููุงุช ูุฑุชูู
- โ ูุฃู `status` ุณูููู `paid` ุจุงููุนู

---

## ๐ง ุงูุฅุดุนุงุฑุงุช

### **ูููุณุชุฎุฏููู:**
```
๐ ุชู ุฏูุน ุนูููุงุชู ุงูุดูุฑูุฉ
ุชู ุฏูุน ุนูููุงุชู ุจูููุฉ $25.50 ุจูุฌุงุญ. ุดูุฑุงู ูู!
```

### **ููุฃุฏูู:**
```
๐ ุชูุฑูุฑ ุงูุฏูุน ุงูุดูุฑู - ููููุจุฑ 2025

โ ุชู ุฏูุน $125.50 ูู 5 ูุณุชุฎุฏููู

ุงูุชูุงุตูู:
1. ahmed - $25.50 (3 ุนูููุฉ)
2. sara - $30.00 (2 ุนูููุฉ)
3. mohammed - $20.00 (1 ุนูููุฉ)
4. fatima - $35.00 (4 ุนูููุฉ)
5. ali - $15.00 (2 ุนูููุฉ)
```

---

## ๐๏ธ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### **ุงููุดููุฉ: ุงูุฏุงูุฉ ูุง ุชุนูู ุชููุงุฆูุงู**

**ุงูุญู:**
```bash
# ุงูุชุญูู ูู Cron
supabase functions list --with-cron

# ุงูุชุญูู ูู enabled = true ูู cron.toml
cat supabase/functions/monthly-commission-payout/cron.toml
```

---

### **ุงููุดููุฉ: ุฎุทุฃ ูู ุงููุนุงูุฌุฉ**

**ุงูุญู:**
```sql
-- ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงููุธุงู
SELECT * FROM referral_settings;

-- ุงูุชุญูู ูู ุงูุนูููุงุช ุงููุนููุฉ
SELECT * FROM get_pending_commissions_summary();

-- ุงูุชุญูู ูู ุงูุจูุงูุงุช
SELECT 
  pc.referrer_id,
  u.username,
  SUM(pc.commission_amount) as total
FROM pending_commissions pc
INNER JOIN users u ON u.id = pc.referrer_id
WHERE pc.status = 'pending'
GROUP BY pc.referrer_id, u.username;
```

---

### **ุงููุดููุฉ: ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช**

**ุงูุญู:**
```sql
-- ุงูุชุญูู ูู ุฌุฏูู ุงูุฅุดุนุงุฑุงุช
SELECT * FROM notifications 
WHERE type = 'commission_paid' 
ORDER BY created_at DESC 
LIMIT 10;

-- ุงูุชุญูู ูู ุงููุฏูุฑูู
SELECT id, username, email, role 
FROM users 
WHERE role = 'admin' AND is_active = true;
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### **1. ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ:**
- ูุชู ุฌูุจู ูู `referral_settings.minimum_payout`
- ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ: $10
- ูููู ุชุบููุฑู ูู: `ููุญุฉ ุงูุชุญูู โ ุงูุฅุนุฏุงุฏุงุช`

### **2. ุฏูุฑุฉ ุงูุฏูุน:**
- ุญุงููุงู: ุดูุฑูุงู (ุงูููู ุงูุฃูู)
- ูุชุบููุฑ ุงูุชูููุช: ุนุฏู `cron.toml`

**ุฃูุซูุฉ:**
```toml
# ูู ุฃุณุจูุน (ุงูุฃุญุฏ)
schedule = "0 0 * * 0"

# ูู 15 ููู
schedule = "0 0 1,15 * *"

# ูู ููู (ููุงุฎุชุจุงุฑ ููุท!)
schedule = "0 0 * * *"
```

### **3. ุทุฑู ุงูุฏูุน:**
- ูุชู ุฌูุจูุง ูู `payment_methods` ุญูุซ `is_primary = true`
- ุฅุฐุง ูู ูุญุฏุฏ ุงููุณุชุฎุฏู ุทุฑููุฉ ุฏูุนุ ูุชู ุชุณุฌูู `pending_setup`

### **4. ุงูุณุฌูุงุช:**
- ุฌููุน ุงูุนูููุงุช ูุณุฌูุฉ ูู `commission_payments`
- ูููู ุงูุฑุฌูุน ุฅูููุง ูู ุฃู ููุช

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### **ุงูุณููุงุฑูู 1: ุฏูุน ูุงุฌุญ**
```sql
-- ุฅูุดุงุก ุนูููุงุช ุชุฌุฑูุจูุฉ
INSERT INTO pending_commissions (referrer_id, commission_amount, status)
VALUES 
  ('user-id-1', 25.50, 'pending'),
  ('user-id-2', 15.00, 'pending');

-- ุชุดุบูู ุงูุฏูุน
SELECT * FROM process_monthly_commissions();

-- ุงูุชุญูู ูู ุงููุชูุฌุฉ
SELECT * FROM commission_payments ORDER BY created_at DESC LIMIT 1;
```

### **ุงูุณููุงุฑูู 2: ุฃูู ูู ุงูุญุฏ ุงูุฃุฏูู**
```sql
-- ุฅูุดุงุก ุนูููุฉ ุฃูู ูู $10
INSERT INTO pending_commissions (referrer_id, commission_amount, status)
VALUES ('user-id-3', 5.00, 'pending');

-- ุชุดุบูู ุงูุฏูุน
SELECT * FROM process_monthly_commissions();

-- ุงููุชูุฌุฉ: ูู ูุชู ุงูุฏูุน
```

### **ุงูุณููุงุฑูู 3: ุชุดุบูู ูุฑุชูู**
```sql
-- ุชุดุบูู ุฃูู
SELECT * FROM process_monthly_commissions();

-- ุชุดุบูู ุซุงูู (ููุณ ุงูููู)
SELECT * FROM process_monthly_commissions();

-- ุงููุชูุฌุฉ: "ูุง ุชูุฌุฏ ุนูููุงุช ูุณุชุญูุฉ ููุฏูุน"
```

---

## ๐ ุงูุฏุนู ูุงููุฑุงุฌุน

### **Supabase Docs:**
- [Edge Functions](https://supabase.com/docs/guides/functions)
- [Cron Jobs](https://supabase.com/docs/guides/functions/schedule-functions)
- [Database Functions](https://supabase.com/docs/guides/database/functions)

### **ุงููููุงุช ุฐุงุช ุงูุตูุฉ:**
```
๐ supabase/
  โโโ migrations/20251102_process_monthly_commissions.sql
  โโโ functions/monthly-commission-payout/
      โโโ index.ts
      โโโ cron.toml
      โโโ README.md

๐ src/components/
  โโโ admin/AutoPayoutSettings.tsx
  โโโ admin/CommissionManagement.tsx
  โโโ referral/ReferralPanel.tsx
```

---

## โ ูุงุฆูุฉ ุงูุชุญูู ุงูููุงุฆูุฉ

ูุจู ุงูุงูุชูุงู ุฅูู ุงูุฅูุชุงุฌุ ุชุฃูุฏ ูู:

- [ ] ุชุทุจูู Database Migration ุจูุฌุงุญ
- [ ] ูุดุฑ Edge Function
- [ ] ุงูุชุญูู ูู Cron Job ููุนูู
- [ ] ุงุฎุชุจุงุฑ ุงูุฏุงูุฉ ูุฏููุงู
- [ ] ุงูุชุญูู ูู ุงูุฅุดุนุงุฑุงุช ุชุนูู
- [ ] ูุฑุงุฌุนุฉ ุฅุนุฏุงุฏุงุช `referral_settings`
- [ ] ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุฏูุฑูู ูุดุทูู
- [ ] ุงุฎุชุจุงุฑ ููุญุฉ ุงูุชุญูู ููุฃุฏูู

---

## ๐ ุงูุฎูุงุตุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ูุขูู ููุฏูุน ุงูุชููุงุฆู ุงูุดูุฑู:

โ **ุชููุงุฆู ุจุงููุงูู** - ูุนูู ูู ุงูููู ุงูุฃูู ูู ูู ุดูุฑ  
โ **ุขูู** - ูุนุงูุฌุฉ ุฏุงุฎู ูุงุนุฏุฉ ุงูุจูุงูุงุช  
โ **ููุซูู** - Atomic operations  
โ **ุดูุงู** - ุฅุดุนุงุฑุงุช ููุฌููุน  
โ **ูุงุจู ููุชุชุจุน** - ุณุฌูุงุช ูุงููุฉ  
โ **ูุฑู** - ูููู ุชุดุบููู ูุฏููุงู  
โ **ุฐูู** - ูุชุญูู ูู ุงูุญุฏ ุงูุฃุฏูู  
โ **ุฏููู** - ูุง ูุฏูุน ููุณ ุงูุนูููุฉ ูุฑุชูู  

**๐ ุงููุธุงู ุฌุงูุฒ ูููุดุฑ ูุงูุงุณุชุฎุฏุงู ุงูููุฑู!**
